# Hook Fix: Working Directory Issue

**Date**: 2025-12-25
**Problem**: Hooks failing with "file not found" when working in subdirectories
**Status**: Fixed (requires Claude Code restart)

## The Problem

Hooks were failing with errors like:
```
python3: can't open file '/home/jpoley/prj/jp/flowspec/utils/.claude/hooks/stop-quality-gate.py':
[Errno 2] No such file or directory
```

**Root Cause**: Hooks use relative paths (`.claude/hooks/...`) but were being executed from the current working directory instead of the project root. When working in `utils/flowspec-netlog/` or other subdirectories, the hooks couldn't find their scripts.

## The Fix

### 1. Created Hook Wrapper Script

**File**: `.claude/hooks/run-hook.sh`

This wrapper:
- Finds the project root by searching for `.claude/` directory
- Changes to project root before executing hooks
- Provides better error messages
- Preserves hook exit codes

### 2. Updated Hook Configuration

**File**: `.claude/settings.json`

All hooks now use the wrapper:

**Before**:
```json
{
  "type": "command",
  "command": "python3 .claude/hooks/stop-quality-gate.py",
  "timeout": 5
}
```

**After**:
```json
{
  "type": "command",
  "command": "bash .claude/hooks/run-hook.sh python3 .claude/hooks/stop-quality-gate.py",
  "timeout": 5
}
```

### 3. Applied to All Hooks

- ✅ SessionStart hooks
- ✅ PreToolUse hooks (permission-auto-approve, sensitive-files, git-safety)
- ✅ PostToolUse hooks (format-python, lint-python, slash-command-emit, task-memory-lifecycle)
- ✅ Stop hooks (quality-gate)

## How to Apply

**IMPORTANT**: You must restart Claude Code for the new settings to take effect.

1. Exit Claude Code completely
2. Restart Claude Code
3. Hooks will now work from any directory

## Testing

To verify the fix works:

```bash
# From any subdirectory, test the wrapper
cd utils/flowspec-netlog
bash ../../.claude/hooks/run-hook.sh pwd
# Should output: /home/jpoley/prj/jp/flowspec (project root)

# Test actual hook
echo '{"conversationSummary": "test"}' | \
  bash ../../.claude/hooks/run-hook.sh python3 .claude/hooks/stop-quality-gate.py
# Should output JSON with "continue": true
```

## Why This Burned Tokens

When hooks fail, Claude Code:
1. Shows error message in the conversation
2. Claude tries to handle the error
3. Every subsequent Bash command triggers the same broken hooks
4. Creates an infinite error loop that burns tokens

The fix prevents this by ensuring hooks can always find their scripts, regardless of the current working directory.

## Additional Benefits

1. **Better error messages**: Wrapper provides clear errors if project root can't be found
2. **Robustness**: Works from any subdirectory, including nested git repos
3. **Consistency**: All hooks use the same execution pattern
4. **Debugging**: Easier to test hooks manually with the wrapper

## Files Changed

- `.claude/hooks/run-hook.sh` (new)
- `.claude/settings.json` (updated)

## Related Issues

This fix also prevents similar issues with:
- Working in temporary directories
- Nested git repositories
- Symlinked directories
- Any scenario where `PWD != project root`
