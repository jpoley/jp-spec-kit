name: Role-Based Validation

on:
  push:
    branches: [main]
    paths:
      - 'templates/commands/**'
      - 'flowspec_workflow.yml'
      - 'schemas/**'
      - '.claude/commands/**'
      - 'scripts/validate-workflow-config.py'
  pull_request:
    branches: [main]
    paths:
      - 'templates/commands/**'
      - 'flowspec_workflow.yml'
      - 'schemas/**'
      - '.claude/commands/**'
      - 'scripts/validate-workflow-config.py'

jobs:
  # Job 1: Validate workflow schema
  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Validate flowspec_workflow.yml against schema
        run: |
          echo "=== Validating flowspec_workflow.yml against JSON schema ==="
          uv run python scripts/validate-workflow-config.py flowspec_workflow.yml schemas/flowspec_workflow.schema.json

      - name: Check schema version compatibility
        run: |
          echo "=== Checking schema version compatibility ==="
          WORKFLOW_VERSION=$(uv run python -c "import yaml; print(yaml.safe_load(open('flowspec_workflow.yml'))['version'])")
          SCHEMA_VERSION=$(uv run python -c "import json; print(json.load(open('schemas/flowspec_workflow.schema.json'))['properties']['version']['examples'][0])")
          echo "Workflow version: $WORKFLOW_VERSION"
          echo "Schema version: $SCHEMA_VERSION"

          # Validate version format (use [0-9] for portability, \d is not portable)
          if ! echo "$WORKFLOW_VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid workflow version format: $WORKFLOW_VERSION"
            exit 1
          fi
          echo "✓ Version format valid"

  # Job 2: Validate role command structure
  validate-commands:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Verify role command files exist
        run: |
          echo "=== Verifying role command files exist ==="
          uv run python << 'PYTHON'
          import yaml
          from pathlib import Path

          # Load workflow config
          with open('flowspec_workflow.yml') as f:
              config = yaml.safe_load(f)

          roles = config.get('roles', {}).get('definitions', {})
          errors = []

          # Check each role's commands
          for role_name, role_data in roles.items():
              commands = role_data.get('commands', [])
              if role_name == 'all':
                  # 'all' role has no commands
                  continue

              for command in commands:
                  # Check if command file exists in templates/commands/{role}/{command}.md
                  command_path = Path(f'templates/commands/{role_name}/{command}.md')
                  if not command_path.exists():
                      errors.append(f"Missing command file: {command_path}")
                  else:
                      print(f"✓ Found: {command_path}")

          if errors:
              print("\n❌ Errors found:")
              for error in errors:
                  print(f"  - {error}")
              exit(1)

          print("\n✓ All role command files exist")
          PYTHON

      - name: Validate agent-to-role mappings
        run: |
          echo "=== Validating agent-to-role mappings ==="
          uv run python << 'PYTHON'
          import yaml

          with open('flowspec_workflow.yml') as f:
              config = yaml.safe_load(f)

          # Extract all agents from workflows
          workflow_agents = set()
          for workflow_name, workflow in config.get('workflows', {}).items():
              for agent in workflow.get('agents', []):
                  if isinstance(agent, dict):
                      agent_name = agent.get('name')
                  else:
                      agent_name = agent
                  if agent_name:
                      workflow_agents.add(agent_name)

          # Extract all agents from roles
          role_agents = set()
          for role_name, role_data in config.get('roles', {}).get('definitions', {}).items():
              for agent in role_data.get('agents', []):
                  # Remove @ prefix
                  agent_name = agent.lstrip('@')
                  role_agents.add(agent_name)

          # Check coverage (workflow agents should be assigned to roles)
          unassigned = workflow_agents - role_agents
          if unassigned:
              print(f"⚠ Warning: Agents in workflows but not assigned to roles:")
              for agent in sorted(unassigned):
                  print(f"  - {agent}")

          print(f"\n✓ Agent mappings validated")
          print(f"  - Workflow agents: {len(workflow_agents)}")
          print(f"  - Role agents: {len(role_agents)}")
          PYTHON

      - name: Check for command file naming conventions
        run: |
          echo "=== Checking command file naming conventions ==="

          # Commands should be lowercase with hyphens or underscores
          # Pattern: lowercase letter followed by lowercase letters, digits, hyphens, or underscores
          INVALID_NAMES=$(find templates/commands -name "*.md" ! -name "_*" | while read file; do
            basename=$(basename "$file" .md)
            if ! echo "$basename" | grep -qE '^[a-z][a-z0-9_-]*$'; then
              echo "$file"
            fi
          done)

          if [ -n "$INVALID_NAMES" ]; then
            echo "❌ Invalid command file names (must be lowercase with hyphens/underscores):"
            echo "$INVALID_NAMES" | sed 's/^/  - /'
            exit 1
          fi

          echo "✓ All command files follow naming conventions"

  # Job 3: Dev role validation
  # NOTE: PM role removed - PM work is done via /flowspec workflow commands
  validate-dev-role:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Validate Dev role agents
        run: |
          echo "=== Validating Dev role agents ==="
          uv run python << 'PYTHON'
          import yaml

          with open('flowspec_workflow.yml') as f:
              config = yaml.safe_load(f)

          dev_role = config['roles']['definitions']['dev']

          # NOTE: Role-based commands removed in standalone consolidation
          # Only verify agents are configured correctly

          # Verify Dev agents include engineers
          agents = set(dev_role['agents'])
          expected_engineers = {'@frontend-engineer', '@backend-engineer'}

          missing_engineers = expected_engineers - agents
          if missing_engineers:
              print(f"❌ Dev role missing engineers: {missing_engineers}")
              exit(1)

          print(f"✓ Dev role has required agents: {len(agents)} agents")
          PYTHON

      - name: Run unit tests
        env:
          GITHUB_FLOWSPEC: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Running unit tests ==="
          uv run pytest tests/ -v --cov=src/flowspec_cli --cov-report=term-missing -k "not integration and not git_sync"

      - name: Check ADR format (if ADRs exist)
        run: |
          echo "=== Checking ADR format ==="
          if [ -d "docs/adr" ]; then
            # Check ADR naming: ADR-NNN-title.md
            INVALID_ADRS=$(find docs/adr -name "*.md" ! -name "README.md" | while read adr; do
              basename=$(basename "$adr")
              if ! echo "$basename" | grep -qE '^ADR-[0-9]{3,}-[a-z0-9-]+\.md$'; then
                echo "$adr"
              fi
            done)

            if [ -n "$INVALID_ADRS" ]; then
              echo "⚠ Warning: ADRs not following naming convention (ADR-NNN-title.md):"
              echo "$INVALID_ADRS" | sed 's/^/  - /'
            else
              echo "✓ All ADRs follow naming convention"
            fi
          else
            echo "⚠ No ADR directory found (skipping validation)"
          fi

  # Job 6: Security role validation
  validate-sec-role:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Validate Security role agents
        run: |
          echo "=== Validating Security role agents ==="
          uv run python << 'PYTHON'
          import yaml

          with open('flowspec_workflow.yml') as f:
              config = yaml.safe_load(f)

          sec_role = config['roles']['definitions']['sec']

          # NOTE: Role-based commands removed in standalone consolidation
          # Only verify agents are configured correctly

          # Verify security agent
          agents = set(sec_role['agents'])
          if '@secure-by-design-engineer' not in agents:
              print(f"❌ Security role missing @secure-by-design-engineer agent")
              exit(1)

          print(f"✓ Security role has required agent")
          PYTHON

      - name: Run security scan (bandit)
        continue-on-error: true
        run: |
          echo "=== Running security scan with bandit ==="
          uv tool run bandit -r src/ -ll -f json -o bandit-report.json || true

          # Display findings summary
          if [ -f "bandit-report.json" ]; then
            uv run python << 'PYTHON'
          import json

          with open('bandit-report.json') as f:
              report = json.load(f)

          results = report.get('results', [])
          metrics = report.get('metrics', {})

          total = metrics.get('_totals', {})
          high = total.get('SEVERITY.HIGH', 0)
          medium = total.get('SEVERITY.MEDIUM', 0)
          low = total.get('SEVERITY.LOW', 0)

          print(f"\n=== Bandit Security Scan Summary ===")
          print(f"High severity: {high}")
          print(f"Medium severity: {medium}")
          print(f"Low severity: {low}")
          print(f"Total issues: {len(results)}")
          PYTHON
          fi

      - name: Check security config
        run: |
          echo "=== Checking security configuration ==="

          # Verify GitHub security config exists
          if [ ! -f ".github/security-config.yml" ]; then
            echo "⚠ Warning: No .github/security-config.yml found"
          else
            echo "✓ Security config exists"
          fi

          # Check for security workflows
          if [ ! -f ".github/workflows/security-scan.yml" ]; then
            echo "⚠ Warning: No security-scan workflow found"
          else
            echo "✓ Security scan workflow exists"
          fi

  # Job 7: QA role validation
  validate-qa-role:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Validate QA role agents
        run: |
          echo "=== Validating QA role agents ==="
          uv run python << 'PYTHON'
          import yaml

          with open('flowspec_workflow.yml') as f:
              config = yaml.safe_load(f)

          qa_role = config['roles']['definitions']['qa']

          # NOTE: Role-based commands removed in standalone consolidation
          # Only verify agents are configured correctly

          # Verify QA agents
          agents = set(qa_role['agents'])
          expected_agents = {'@quality-guardian', '@release-manager'}

          missing_agents = expected_agents - agents
          if missing_agents:
              print(f"❌ QA role missing agents: {missing_agents}")
              exit(1)

          print(f"✓ QA role has required agents: {len(agents)} agents")
          PYTHON

      - name: Check test coverage
        run: |
          echo "=== Checking test coverage ==="
          uv run pytest tests/ -v --cov=src/flowspec_cli --cov-report=term-missing --cov-report=json -k "not git_sync"

          # Check coverage threshold
          uv run python << 'PYTHON'
          import json

          with open('coverage.json') as f:
              coverage = json.load(f)

          total_coverage = coverage['totals']['percent_covered']
          threshold = 70.0

          print(f"\nTest coverage: {total_coverage:.1f}%")
          print(f"Threshold: {threshold}%")

          if total_coverage < threshold:
              print(f"⚠ Warning: Coverage below threshold ({total_coverage:.1f}% < {threshold}%)")
          else:
              print(f"✓ Coverage meets threshold")
          PYTHON

      - name: Check documentation links
        continue-on-error: true
        run: |
          echo "=== Checking documentation links ==="

          # Find broken links in markdown files
          BROKEN_LINKS=$(find docs -name "*.md" -type f | while read file; do
            # Extract markdown links
            grep -oP '\[.*?\]\(\K[^)]+' "$file" 2>/dev/null | while read link; do
              # Skip external links
              if [[ "$link" =~ ^https?:// ]]; then
                continue
              fi

              # Resolve relative path
              dir=$(dirname "$file")
              if [ ! -e "$dir/$link" ] && [ ! -e "$link" ]; then
                echo "$file: broken link -> $link"
              fi
            done
          done)

          if [ -n "$BROKEN_LINKS" ]; then
            echo "⚠ Warning: Found broken links:"
            echo "$BROKEN_LINKS" | sed 's/^/  - /'
          else
            echo "✓ No broken links found"
          fi

  # Job 8: Team mode validation
  validate-team-mode:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for .vscode/settings.json in team mode
        run: |
          echo "=== Checking team mode compliance ==="

          # Detect if project is in team mode (multiple contributors)
          CONTRIBUTOR_COUNT=$(git log --format='%ae' | sort -u | wc -l)
          echo "Contributor count: $CONTRIBUTOR_COUNT"

          if [ $CONTRIBUTOR_COUNT -gt 1 ]; then
            echo "Project is in TEAM MODE (multiple contributors)"

            # Check if .vscode/settings.json is committed
            if git ls-files --error-unmatch .vscode/settings.json >/dev/null 2>&1; then
              echo ""
              echo "❌ ERROR: .vscode/settings.json is committed in team mode"
              echo ""
              echo "Team mode requires user-specific VS Code settings."
              echo "Each developer should have their own .vscode/settings.json (gitignored)."
              echo ""
              echo "Fix:"
              echo "  1. Add .vscode/settings.json to .gitignore"
              echo "  2. Remove from git: git rm --cached .vscode/settings.json"
              echo "  3. Each developer runs: bash scripts/bash/sync-copilot-agents.sh --with-vscode"
              echo ""
              exit 1
            fi

            echo "✓ No .vscode/settings.json in team mode (correct)"
          else
            echo "Project is in SOLO MODE (single contributor)"
            echo "✓ Team mode validation passed (not applicable)"
          fi

      - name: Verify .gitignore for team mode
        run: |
          echo "=== Checking .gitignore configuration ==="

          # Check if .vscode/settings.json should be in .gitignore for team mode
          if [ -f ".gitignore" ]; then
            if grep -q "^\.vscode/settings\.json$" .gitignore; then
              echo "✓ .vscode/settings.json is in .gitignore (team-friendly)"
            else
              echo "⚠ Warning: Consider adding .vscode/settings.json to .gitignore for team mode"
            fi
          else
            echo "⚠ Warning: No .gitignore found"
          fi

  # Job 9: Ops role validation
  validate-ops-role:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Validate Ops role agents
        run: |
          echo "=== Validating Ops role agents ==="
          uv run python << 'PYTHON'
          import yaml

          with open('flowspec_workflow.yml') as f:
              config = yaml.safe_load(f)

          ops_role = config['roles']['definitions']['ops']

          # NOTE: Role-based commands removed in standalone consolidation
          # Only verify agents are configured correctly

          # Verify SRE agent
          agents = set(ops_role['agents'])
          if '@sre-agent' not in agents:
              print(f"❌ Ops role missing @sre-agent")
              exit(1)

          print(f"✓ Ops role has required agent")
          PYTHON

      - name: Check CI/CD workflow files
        run: |
          echo "=== Checking CI/CD workflow files ==="

          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -type f | wc -l)
          echo "Found $WORKFLOW_COUNT workflow files"

          if [ $WORKFLOW_COUNT -eq 0 ]; then
            echo "⚠ Warning: No GitHub Actions workflows found"
          else
            echo "✓ CI/CD workflows exist"

            # List workflows
            find .github/workflows -name "*.yml" -type f -exec basename {} \; | sort
          fi

  # Summary job (optional - runs after all validations)
  validation-summary:
    needs: [validate-schema, validate-commands, validate-dev-role, validate-sec-role, validate-qa-role, validate-team-mode, validate-ops-role]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "=== Role-Based Validation Summary ==="
          echo ""
          echo "All role validation jobs completed."
          echo ""
          echo "Jobs:"
          if [ "${{ needs.validate-schema.result }}" = "success" ]; then echo "  ✓ Schema validation"; else echo "  ❌ Schema validation"; fi
          if [ "${{ needs.validate-commands.result }}" = "success" ]; then echo "  ✓ Command structure validation"; else echo "  ❌ Command structure validation"; fi
          if [ "${{ needs.validate-dev-role.result }}" = "success" ]; then echo "  ✓ Dev role validation"; else echo "  ❌ Dev role validation"; fi
          if [ "${{ needs.validate-sec-role.result }}" = "success" ]; then echo "  ✓ Security role validation"; else echo "  ❌ Security role validation"; fi
          if [ "${{ needs.validate-qa-role.result }}" = "success" ]; then echo "  ✓ QA role validation"; else echo "  ❌ QA role validation"; fi
          if [ "${{ needs.validate-team-mode.result }}" = "success" ]; then echo "  ✓ Team mode validation"; else echo "  ❌ Team mode validation"; fi
          if [ "${{ needs.validate-ops-role.result }}" = "success" ]; then echo "  ✓ Ops role validation"; else echo "  ❌ Ops role validation"; fi
          echo ""
          echo "See individual job logs for details."
