# Automatically create release tag when a release PR is merged
# This workflow detects merged PRs from release/* branches and creates the git tag,
# which then triggers the main release.yml workflow.
#
# Security: All GitHub context values are passed via env: blocks to prevent
# script injection attacks. Branch names are validated against strict patterns.

name: Create Release Tag on Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  create-tag:
    # Only run if PR was merged (not just closed) AND it's from a release branch
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate and extract version from branch name
        id: version
        env:
          # Pass branch name via env to prevent script injection
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          # Validate branch name format strictly (release/vX.Y.Z only)
          if ! [[ "$PR_BRANCH" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid branch name format: $PR_BRANCH"
            echo "::error::Expected format: release/vX.Y.Z (e.g., release/v0.2.344)"
            exit 1
          fi

          # Extract version from branch name (release/v0.2.344 -> v0.2.344)
          VERSION="${PR_BRANCH#release/}"
          VERSION_NUM="${VERSION#v}"

          # Additional validation: ensure version components are valid
          if ! [[ "$VERSION_NUM" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION_NUM"
            exit 1
          fi

          echo "branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "version_num=$VERSION_NUM" >> "$GITHUB_OUTPUT"

          echo "Branch: $PR_BRANCH"
          echo "Tag to create: $VERSION"
          echo "Version number: $VERSION_NUM"

      - name: Verify version in source files
        env:
          TAG_VERSION: ${{ steps.version.outputs.version_num }}
        run: |
          # Get version from pyproject.toml
          TOML_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml || echo "")

          # Get version from __init__.py
          INIT_VERSION=$(grep -Po '(?<=__version__ = ")[^"]*' src/specify_cli/__init__.py || echo "")

          echo "Expected version: $TAG_VERSION"
          echo "pyproject.toml: $TOML_VERSION"
          echo "__init__.py: $INIT_VERSION"

          if [ "$TAG_VERSION" != "$TOML_VERSION" ]; then
            echo "::error::Version mismatch! Expected: $TAG_VERSION, pyproject.toml: $TOML_VERSION"
            exit 1
          fi

          if [ -n "$INIT_VERSION" ] && [ "$TAG_VERSION" != "$INIT_VERSION" ]; then
            echo "::error::Version mismatch! Expected: $TAG_VERSION, __init__.py: $INIT_VERSION"
            exit 1
          fi

          echo "Version files are in sync with release branch"

      - name: Check if tag already exists
        env:
          TAG: ${{ steps.version.outputs.version }}
        run: |
          if git tag -l "$TAG" | grep -q .; then
            echo "::error::Tag $TAG already exists!"
            exit 1
          fi
          echo "Tag $TAG does not exist, proceeding"

      - name: Read pinned release commit
        id: release-commit
        run: |
          # Read the .release-commit file that was created by release.py
          # This file contains the commit SHA that should be tagged
          if [ ! -f ".release-commit" ]; then
            echo "::warning::No .release-commit file found. Using HEAD for backward compatibility."
            RELEASE_COMMIT=$(git rev-parse HEAD)
          else
            RELEASE_COMMIT=$(cat .release-commit | tr -d '[:space:]')
          fi

          # Validate the commit hash format (40 hex characters)
          if ! [[ "$RELEASE_COMMIT" =~ ^[a-f0-9]{40}$ ]]; then
            echo "::error::Invalid commit hash format in .release-commit: $RELEASE_COMMIT"
            exit 1
          fi

          # Verify the commit exists
          if ! git cat-file -e "$RELEASE_COMMIT^{commit}" 2>/dev/null; then
            echo "::error::Commit $RELEASE_COMMIT does not exist in repository"
            exit 1
          fi

          # Verify the commit is an ancestor of HEAD (i.e., it's part of history)
          if ! git merge-base --is-ancestor "$RELEASE_COMMIT" HEAD; then
            echo "::error::Commit $RELEASE_COMMIT is not an ancestor of HEAD"
            echo "::error::This could indicate a race condition or incorrect commit hash"
            exit 1
          fi

          echo "release_commit=$RELEASE_COMMIT" >> "$GITHUB_OUTPUT"
          echo "Release commit: $RELEASE_COMMIT"
          echo "Commit is verified as ancestor of HEAD"

      - name: Create and push tag
        env:
          TAG: ${{ steps.version.outputs.version }}
          RELEASE_COMMIT: ${{ steps.release-commit.outputs.release_commit }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag on the PINNED commit (not HEAD)
          git tag -a "$TAG" "$RELEASE_COMMIT" -m "Release $TAG"

          # Push tag (this will trigger release.yml)
          git push origin "$TAG"

          echo "Created and pushed tag: $TAG"
          echo "Tag points to commit: $RELEASE_COMMIT"
          echo "This will trigger the release workflow to build and publish the release."

      - name: Summary
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH: ${{ steps.version.outputs.branch }}
          TAG: ${{ steps.version.outputs.version }}
          RELEASE_COMMIT: ${{ steps.release-commit.outputs.release_commit }}
        run: |
          {
            echo "## Release Tag Created"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| PR | #$PR_NUMBER |"
            echo "| Branch | $BRANCH |"
            echo "| Tag | $TAG |"
            echo "| Tagged Commit | \`${RELEASE_COMMIT:0:8}\` |"
            echo ""
            echo "The release workflow will now build packages and create the GitHub Release."
            echo ""
            echo "**Note**: Tag was created on the pinned commit from \`.release-commit\`, not HEAD."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Delete release branch
        if: success()
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "Deleting release branch: $BRANCH"
          git push origin --delete "$BRANCH" || echo "Branch may have been deleted by PR merge settings"
