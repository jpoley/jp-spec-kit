name: Validate Agent Sync

on:
  push:
    branches: [main]
    paths:
      - '.github/agents/**'
      - 'templates/commands/**'
      - 'scripts/bash/sync-copilot-agents.sh'
  pull_request:
    branches: [main]
    paths:
      - '.github/agents/**'
      - 'templates/commands/**'
      - 'scripts/bash/sync-copilot-agents.sh'

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # First job: Auto-fix drift on PRs (ubuntu only)
  auto-fix-drift:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      fixed: ${{ steps.check-drift.outputs.fixed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Check and auto-fix drift
        id: check-drift
        shell: bash
        run: |
          echo "=== Checking for agent drift ==="
          bash scripts/bash/sync-copilot-agents.sh --validate
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 2 ]; then
            echo ""
            echo "âš ï¸ Drift detected - auto-fixing..."
            echo ""

            # Run sync to fix drift
            bash scripts/bash/sync-copilot-agents.sh --force

            # Check if there are changes to commit
            if git diff --quiet .github/agents/; then
              echo "No changes after sync (unexpected)"
              echo "fixed=false" >> "$GITHUB_OUTPUT"
            else
              echo "fixed=true" >> "$GITHUB_OUTPUT"
            fi
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Agent sync validation failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          else
            echo "âœ“ No drift detected"
            echo "fixed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push auto-fix
        if: steps.check-drift.outputs.fixed == 'true'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .github/agents/
          git commit -m "chore(agents): auto-sync from template changes

          ðŸ¤– This commit was automatically generated by CI when agent drift was detected.

          Triggered by changes to templates/commands/ in this PR."

          git push

          echo ""
          echo "âœ… Auto-fix committed and pushed"
          echo "CI will re-run to validate the fix."

      - name: Generate job summary
        if: always()
        shell: bash
        env:
          FIXED: ${{ steps.check-drift.outputs.fixed }}
          JOB_STATUS: ${{ job.status }}
        run: |
          {
            echo "## Agent Sync Auto-Fix"
            echo ""
            if [ "$FIXED" = "true" ]; then
              echo "âœ… **Drift detected and auto-fixed**"
              echo ""
              echo "A commit was pushed to sync agents with templates."
              echo "CI will re-run to validate."
            else
              echo "âœ“ No drift detected - agents are in sync"
            fi
          } >> $GITHUB_STEP_SUMMARY

  # Second job: Validate on all platforms (runs after auto-fix if on PR)
  validate-agent-sync:
    needs: [auto-fix-drift]
    # Skip if auto-fix pushed a commit (a new run will be triggered)
    if: |
      always() &&
      (github.event_name == 'push' ||
       (needs.auto-fix-drift.result == 'success' && needs.auto-fix-drift.outputs.fixed != 'true'))
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use head_ref for PRs to get the latest commit
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Check for agent drift
        shell: bash
        run: |
          echo "=== Checking for agent drift between commands and generated agents ==="
          bash scripts/bash/sync-copilot-agents.sh --validate
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 2 ]; then
            echo ""
            echo "âŒ Drift detected!"
            echo "Generated agents in .github/agents/ are out of sync with commands."
            echo ""
            echo "This should have been auto-fixed. If you see this error:"
            echo "  1. Pull latest changes: git pull"
            echo "  2. Or run locally: ./scripts/bash/sync-copilot-agents.sh --force"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âŒ Agent sync validation failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

          echo "âœ“ No drift detected - agents are in sync"

      - name: Generate job summary
        if: always()
        shell: bash
        env:
          MATRIX_OS: ${{ matrix.os }}
          JOB_STATUS: ${{ job.status }}
        run: |
          {
            echo "## Agent Sync Validation"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Platform | $MATRIX_OS |"
            echo "| Status | $JOB_STATUS |"
            echo ""
            if [ "$JOB_STATUS" == "failure" ]; then
              echo "### Fix Required"
              echo ""
              echo "Run \`./scripts/bash/sync-copilot-agents.sh --force\` to regenerate agents."
            fi
          } >> $GITHUB_STEP_SUMMARY
