name: Version Consistency Check

on:
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'src/flowspec_cli/__init__.py'
      - '.github/workflows/release.yml'
      - '.github/workflows/version-check.yml'
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'src/flowspec_cli/__init__.py'
  workflow_dispatch:

jobs:
  version-check:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags for version comparison

      - name: Get versions
        id: versions
        run: |
          # Get version from pyproject.toml
          PYPROJECT_VERSION=$(grep '^[[:space:]]*version[[:space:]]*=' pyproject.toml | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$PYPROJECT_VERSION" ]; then
            echo "âŒ Failed to extract version from pyproject.toml"
            exit 1
          fi
          echo "pyproject_version=$PYPROJECT_VERSION" >> $GITHUB_OUTPUT

          # Get version from __init__.py
          INIT_VERSION=$(grep '__version__ = ' src/flowspec_cli/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
          if [ -z "$INIT_VERSION" ]; then
            echo "âŒ Failed to extract version from src/flowspec_cli/__init__.py"
            exit 1
          fi
          echo "init_version=$INIT_VERSION" >> $GITHUB_OUTPUT

          # Get latest tag (without v prefix), handle no tags gracefully
          if git tag --list | grep -q .; then
            LATEST_TAG=$(git tag --sort=-v:refname | head -1)
            LATEST_VERSION="${LATEST_TAG#v}"
          else
            LATEST_TAG="none"
            LATEST_VERSION="none"
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ pyproject.toml version: $PYPROJECT_VERSION"
          echo "ðŸ __init__.py version: $INIT_VERSION"
          echo "ðŸ·ï¸ Latest tag: $LATEST_TAG ($LATEST_VERSION)"

      - name: Validate pyproject.toml matches __init__.py
        run: |
          if [ "${{ steps.versions.outputs.pyproject_version }}" != "${{ steps.versions.outputs.init_version }}" ]; then
            echo "âŒ Version mismatch between pyproject.toml and __init__.py!"
            echo "   pyproject.toml: ${{ steps.versions.outputs.pyproject_version }}"
            echo "   __init__.py: ${{ steps.versions.outputs.init_version }}"
            exit 1
          fi
          echo "âœ… pyproject.toml and __init__.py versions match"

      - name: Check version format
        run: |
          VERSION="${{ steps.versions.outputs.pyproject_version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "   Expected: MAJOR.MINOR.PATCH (e.g., 0.2.343)"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"

      - name: Summary
        if: success()
        run: |
          echo "## Version Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| pyproject.toml | ${{ steps.versions.outputs.pyproject_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| __init__.py | ${{ steps.versions.outputs.init_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest Tag | ${{ steps.versions.outputs.latest_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All version checks passed" >> $GITHUB_STEP_SUMMARY
