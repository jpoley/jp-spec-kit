# Git Push Rules Enforcement System - Product Requirements Document

**Feature ID**: push-rules-enforcement
**Parent Task**: task-300
**Status**: Specified
**Author**: @pm-planner
**Created**: 2025-12-07
**Last Updated**: 2025-12-07

---

## 1. Executive Summary

### Problem Statement (Customer Opportunity Focus)

Development teams using JP Spec Kit lack a standardized, enforceable git workflow that ensures code quality gates are always met before code reaches the remote repository. Current pain points include:

- **Inconsistent rebasing**: Merge commits pollute history and create conflicts
- **Skipped validations**: Developers sometimes push without running lint/tests
- **Branch hygiene neglect**: Stale branches and worktrees accumulate
- **Missing cleanup**: Post-validation cleanup tasks are often forgotten
- **No enforcement mechanism**: Rules exist in documentation but aren't enforced

### Proposed Solution (Outcome-Driven)

Implement a **Git Push Rules Enforcement System** that:

1. **Defines explicit rules** in a `push-rules.md` configuration file
2. **Enforces rules automatically** via Claude Code hooks before push/PR operations
3. **Provides cleanup automation** through a `github-janitor` agent
4. **Warns persistently** when cleanup tasks are pending
5. **Integrates seamlessly** with existing `/jpspec:validate` workflow

### Success Metrics (North Star + Key Outcomes)

| Metric | Target | Measurement |
|--------|--------|-------------|
| **North Star**: PRs passing CI on first attempt | 95% | GitHub Actions success rate |
| Merge commits in main | 0 | Git log analysis |
| Stale branches (>30 days) | <5 | Weekly branch audit |
| Lint/test skip rate | 0% | Hook execution logs |
| Janitor warning resolution time | <24 hours | Session tracking |

### Business Value and Strategic Alignment

- **Reduces CI/CD costs**: Fewer failed builds = less compute waste
- **Improves code quality**: Consistent validation prevents regressions
- **Accelerates reviews**: Clean PRs require less reviewer effort
- **Aligns with SLSA**: Enforced workflows support compliance requirements
- **Supports constitution**: Implements critical-rules.md "no direct commits to main"

---

## 2. User Stories and Use Cases

### Primary User Personas

#### Developer (Primary)
- Works on feature branches using git worktrees
- Creates PRs after implementing features
- Needs clear feedback when rules aren't met
- Values automation over manual checklists

#### Tech Lead (Secondary)
- Reviews PRs and ensures code quality
- Configures project-level push rules
- Monitors branch hygiene across team
- Needs visibility into cleanup status

### User Journey Map

```
Developer Journey:
┌──────────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│ Create       │───▶│ Implement   │───▶│ Run          │───▶│ Push/PR     │
│ Worktree     │    │ Feature     │    │ Validation   │    │ (Blocked?)  │
└──────────────┘    └─────────────┘    └──────────────┘    └──────────────┘
                                              │                    │
                                              ▼                    ▼
                                       ┌──────────────┐    ┌─────────────┐
                                       │ Fix Issues   │◀───│ Push Rules  │
                                       │ (if any)     │    │ Check       │
                                       └──────────────┘    └─────────────┘
                                                                  │
                                                                  ▼
                                                           ┌─────────────┐
                                                           │ Janitor     │
                                                           │ Cleanup     │
                                                           └─────────────┘
```

### Detailed User Stories

#### US-1: Push Rules Configuration
**As a** tech lead
**I want to** define push rules in a configuration file
**So that** all team members follow consistent git practices

**Acceptance Criteria**:
- [ ] push-rules.md template is generated by `specify init`
- [ ] File uses structured markdown format
- [ ] Rules are validated on load
- [ ] Invalid configurations produce clear error messages

#### US-2: Pre-Push Validation
**As a** developer
**I want to** be blocked from pushing if validation fails
**So that** I don't waste CI resources on known failures

**Acceptance Criteria**:
- [ ] Hook runs automatically before `git push`
- [ ] Validates rebase status (no merge commits)
- [ ] Runs lint and test checks
- [ ] Provides clear failure messages with remediation steps
- [ ] Can be bypassed with explicit flag for emergencies

#### US-3: Rebase Enforcement
**As a** developer
**I want to** be warned when my branch has merge commits
**So that** I can rebase before pushing

**Acceptance Criteria**:
- [ ] Detects merge commits in branch history since diverging from main
- [ ] Displays affected commits
- [ ] Provides `git rebase -i main` command suggestion
- [ ] Works correctly with git worktrees

#### US-4: Janitor Automation
**As a** developer
**I want to** have branch cleanup happen automatically after validation
**So that** I don't accumulate stale branches

**Acceptance Criteria**:
- [ ] github-janitor runs after `/jpspec:validate` Phase 6
- [ ] Prunes merged branches (respects protected list)
- [ ] Cleans up orphaned worktrees
- [ ] Reports cleanup actions taken

#### US-5: Pending Cleanup Warnings
**As a** developer
**I want to** be warned if janitor hasn't run recently
**So that** I don't forget cleanup tasks

**Acceptance Criteria**:
- [ ] Warning appears in session-start output
- [ ] Shows count of pending cleanup items
- [ ] Clears after janitor runs successfully
- [ ] Non-blocking (doesn't prevent work)

### Edge Cases and Error Scenarios

| Scenario | Expected Behavior |
|----------|-------------------|
| push-rules.md missing | Error with setup instructions |
| push-rules.md invalid YAML | Validation error with line numbers |
| No merge commits but out-of-date | Warning to pull/rebase latest main |
| Tests fail during pre-push | Block with test output summary |
| Worktree with different branch name | Warning about naming convention |
| Emergency bypass needed | `--skip-push-rules` flag available |
| Janitor finds no branches to prune | Success message, no action needed |
| Branch protected from deletion | Skip with explanation |

---

## 3. DVF+V Risk Assessment

### Value Risk (Desirability)

**Risk Level**: Low

**Assessment**:
- Developers already experience pain from failed CI runs
- Manual cleanup is tedious and often skipped
- Existing critical-rules.md shows user desire for enforcement

**Validation Plan**:
1. Survey existing JP Spec Kit users on workflow pain points
2. Measure current CI failure rate as baseline
3. Track adoption rate of push-rules.md in new projects

### Usability Risk (Experience)

**Risk Level**: Medium

**Assessment**:
- Hook blocking could frustrate developers if messages unclear
- Emergency bypass might be overused
- Configuration file format must be intuitive

**Validation Plan**:
1. User testing with 3 developers on pre-push hook flow
2. A/B test error message clarity
3. Monitor bypass flag usage rate

**Mitigation**:
- Clear, actionable error messages with copy-paste commands
- Bypass requires explicit acknowledgment
- Default configuration works out-of-box

### Feasibility Risk (Technical)

**Risk Level**: Low

**Assessment**:
- Hook infrastructure already exists (.claude/hooks/)
- Git commands well-documented
- Pattern matches existing /jpspec:prune-branch

**Validation Plan**:
1. Prototype hook with rebase detection (spike)
2. Test with git worktree edge cases
3. Verify performance impact on push operations

**Technical Constraints**:
- Hook must complete in <5 seconds
- Must work offline (no network requirements)
- Must support all major git versions (2.20+)

### Business Viability Risk (Organizational)

**Risk Level**: Low

**Assessment**:
- Aligns with existing JP Spec Kit philosophy
- No external dependencies
- Supports enterprise compliance requirements

**Validation Plan**:
1. Verify no license conflicts
2. Confirm alignment with SLSA requirements
3. Review with potential enterprise customers

---

## 4. Functional Requirements

### Core Features and Capabilities

#### 4.1 push-rules.md Configuration File

**Location**: Project root (`./push-rules.md`)

**Format**: Structured markdown with YAML frontmatter

```markdown
---
version: "1.0"
enabled: true
bypass_flag: "--skip-push-rules"
---

# Git Push Rules

## Rebase Policy
- **Enforcement**: strict
- **Base Branch**: main
- **Allow Merge Commits**: false

## Validation Requirements

### Linting
- **Required**: true
- **Command**: `uv run ruff check .`
- **Allow Warnings**: false

### Testing
- **Required**: true
- **Command**: `uv run pytest tests/ -x -q`
- **Minimum Coverage**: 0  # Set to 80 for coverage enforcement

## Branch Naming
- **Pattern**: `^(feature|fix|docs|refactor|test)/[a-z0-9-]+$`
- **Enforce**: true

## Janitor
- **Run After Validation**: true
- **Prune Merged Branches**: true
- **Clean Stale Worktrees**: true
- **Protected Branches**: [main, master, develop]
```

#### 4.2 Pre-Push Validation Hook

**Trigger**: Before `git push` command execution

**Validation Sequence**:
1. Load and validate push-rules.md
2. Check rebase status vs base branch
3. Execute lint command
4. Execute test command
5. Validate branch naming convention

**Output Format**:
```
Push Rules Validation
=====================

[1/4] Checking push-rules.md... OK
[2/4] Checking rebase status vs main...
      ✓ No merge commits detected
      ✓ Branch is 2 commits ahead of main
[3/4] Running lint check...
      ✓ ruff check passed (0 errors)
[4/4] Running tests...
      ✓ 45 tests passed

All push rules satisfied. Proceeding with push.
```

**Failure Format**:
```
Push Rules Validation FAILED
============================

[3/4] Running lint check... FAILED
      ✗ 2 errors found:
        src/foo.py:10:1 F401 unused import
        src/bar.py:25:5 E501 line too long

Push blocked. Fix the above issues and try again.

To bypass (emergency only):
  git push --skip-push-rules
```

#### 4.3 github-janitor Agent

**Agent Definition**: `.claude/agents/github-janitor.md`

**Capabilities**:
- Prune merged/deleted branches
- Clean up orphaned worktrees
- Verify PR status and update backlog
- Check branch naming compliance
- Generate cleanup report

**Invocation**: Automatic after `/jpspec:validate` or manual via Task tool

#### 4.4 Warning System

**Integration Point**: session-start.sh hook

**Warning Format**:
```
Environment Warnings:
  ⚠ Janitor cleanup pending: 3 merged branches to prune

Run github-janitor or /jpspec:validate to clear.
```

### User Interface Requirements

- All output uses existing hook output format
- Color-coded status (green=pass, red=fail, yellow=warn)
- Actionable error messages with copy-paste commands
- Progress indicators for long-running checks

### API Requirements

Not applicable - file-based configuration, no REST API.

### Integration Requirements

| System | Integration Type | Details |
|--------|-----------------|---------|
| Claude Code hooks | Event-driven | pre-push, session-start |
| `/jpspec:validate` | Workflow phase | Phase 7: Janitor cleanup |
| `specify init` | Template generation | push-rules.md creation |
| Backlog.md | Task updates | PR status sync |

### Data Requirements

**State Files**:
- `.specify/state/janitor-last-run` - Timestamp of last cleanup
- `.specify/state/pending-cleanup` - List of items to clean

**No Persistent Database**: All state is file-based and git-ignored.

---

## 5. Non-Functional Requirements

### Performance Requirements

| Metric | Requirement |
|--------|-------------|
| Hook startup time | <500ms |
| Rules validation | <100ms |
| Rebase check | <1s |
| Full validation (lint+test) | <2 minutes |
| Janitor cleanup | <30s |

### Scalability Requirements

- Handles repositories with 1000+ branches
- Works with projects having 10+ active worktrees
- No degradation with large git histories

### Security Requirements

- No secrets stored in push-rules.md
- Bypass flag logged to .specify/audit.log
- No network calls during validation
- Safe handling of branch names (no injection)

### Accessibility Requirements

- Text-based output (screen reader compatible)
- Clear contrast in color output
- Non-visual progress indicators (dots/text)

### Compliance Requirements

- Supports SLSA L3 workflow enforcement
- Audit trail for bypasses
- Consistent with critical-rules.md principles

---

## 6. Task Breakdown (Backlog Tasks)

### Created Tasks

| Task ID | Title | Priority | Labels | Dependencies |
|---------|-------|----------|--------|--------------|
| task-300 | Implement Git Push Rules Enforcement System | High | feature, git-workflow | - |
| task-301 | Create push-rules.md Template and Validation Schema | High | implement, backend | task-300 |
| task-302 | Implement Pre-Push Hook for Rules Validation | High | implement, hooks | task-301 |
| task-303 | Define github-janitor Agent Specification | High | implement, agents | task-300 |
| task-304 | Integrate Janitor into /jpspec:validate Workflow | Medium | implement, workflow | task-303 |
| task-305 | Implement Janitor Warning System | Medium | implement, hooks | task-304 |
| task-306 | Implement Rebase-vs-Main Enforcement | High | implement, git-workflow | task-302 |
| task-307 | Update specify init for Push Rules Setup | Medium | implement, cli | task-301 |

### Dependency Graph

```
task-300 (Parent Feature)
    │
    ├── task-301 (push-rules.md template)
    │       │
    │       ├── task-302 (pre-push hook)
    │       │       │
    │       │       └── task-306 (rebase enforcement)
    │       │
    │       └── task-307 (specify init update)
    │
    └── task-303 (github-janitor agent)
            │
            └── task-304 (validate integration)
                    │
                    └── task-305 (warning system)
```

### Estimated Complexity

| Task | Size | Rationale |
|------|------|-----------|
| task-301 | M | Template design + schema + validation |
| task-302 | L | Hook complexity + edge cases |
| task-303 | M | Agent definition + capabilities |
| task-304 | S | Integration point only |
| task-305 | S | Simple state tracking |
| task-306 | M | Git history analysis |
| task-307 | S | CLI extension |

---

## 7. Discovery and Validation Plan

### Learning Goals and Hypotheses

| Hypothesis | Validation Method | Success Criteria |
|------------|-------------------|------------------|
| Developers will adopt push-rules.md | Usage tracking | >80% projects have file |
| Pre-push hooks reduce CI failures | Before/after analysis | 50% reduction |
| Janitor automation saves time | User survey | Net Promoter Score >8 |
| Warning system drives cleanup | Time-to-resolution | <24 hours average |

### Validation Experiments

#### Experiment 1: Hook Usability
- **Method**: 3 developers use pre-push hook for 1 week
- **Metrics**: Bypass rate, error message clarity rating
- **Go/No-Go**: Bypass rate <10%, clarity rating >4/5

#### Experiment 2: Janitor Effectiveness
- **Method**: Compare branch count before/after in pilot project
- **Metrics**: Stale branches, cleanup time
- **Go/No-Go**: 50% reduction in stale branches

### Go/No-Go Decision Points

1. **After task-301**: Validate push-rules.md format is intuitive
2. **After task-302**: Validate hook performance meets requirements
3. **After task-304**: Validate end-to-end workflow integration

---

## 8. Acceptance Criteria and Testing

### Acceptance Test Scenarios

#### Scenario 1: Happy Path Push
```gherkin
Given a developer has a feature branch rebased on main
And all lint checks pass
And all tests pass
When they run git push
Then the push succeeds without blocking
And no warnings are displayed
```

#### Scenario 2: Blocked Push - Merge Commits
```gherkin
Given a developer has a feature branch with merge commits
When they run git push
Then the push is blocked
And error message explains merge commits detected
And rebase command is suggested
```

#### Scenario 3: Janitor Cleanup
```gherkin
Given a developer runs /jpspec:validate
And the PR is created successfully
When Phase 7 executes
Then github-janitor prunes merged branches
And cleanup report is displayed
And janitor-last-run timestamp is updated
```

### Definition of Done

- [ ] All acceptance criteria verified
- [ ] Unit tests for validation logic
- [ ] Integration tests for hook execution
- [ ] Documentation updated
- [ ] No critical security issues
- [ ] Performance requirements met

### Quality Gates

| Gate | Criteria |
|------|----------|
| Code Review | Approved by 1 reviewer |
| CI Pipeline | All checks pass |
| Test Coverage | >80% for new code |
| Security Scan | No high/critical findings |

### Test Coverage Requirements

- Unit tests: All validation functions
- Integration tests: Hook execution flow
- E2E tests: Full push workflow simulation

---

## 9. Dependencies and Constraints

### Technical Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| Git | 2.20+ | Core functionality |
| Claude Code hooks | Latest | Hook execution |
| Python 3.11+ | 3.11+ | Validation logic |
| ruff | Latest | Default lint check |
| pytest | Latest | Default test runner |

### External Dependencies

None - all functionality is local/offline capable.

### Timeline Constraints

- Feature complete before v0.3.0 release
- No hard deadline, quality over speed

### Resource Constraints

- Single developer implementation
- No infrastructure costs (all local)

### Risk Factors

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Hook slows push workflow | Low | Medium | Performance budget enforcement |
| Bypass overuse | Medium | Medium | Audit logging, team norms |
| Complex git histories | Low | Low | Graceful fallback behavior |

---

## 10. Success Metrics (Outcome-Focused)

### North Star Metric

**PRs Passing CI on First Attempt**: Target 95%

This metric captures the ultimate goal: developers submit PRs that work the first time because validations ran locally first.

### Leading Indicators (Early Signals)

| Indicator | Target | Measurement Frequency |
|-----------|--------|----------------------|
| push-rules.md adoption rate | 90% of new projects | Monthly |
| Hook execution count | 10+ per developer/week | Weekly |
| Bypass flag usage | <5% of pushes | Weekly |
| Janitor warning resolution | <24 hours | Continuous |

### Lagging Indicators (Final Outcomes)

| Indicator | Target | Measurement Frequency |
|-----------|--------|----------------------|
| CI failure rate reduction | -50% | Monthly |
| Stale branch count | <5 per project | Monthly |
| Review cycle time | -20% | Monthly |
| Developer satisfaction | NPS >8 | Quarterly |

### Measurement Approach

1. **Hook telemetry**: Log execution to .specify/audit.log
2. **CI metrics**: GitHub Actions analytics
3. **Branch audits**: Weekly automated reports
4. **User surveys**: Quarterly feedback collection

### Target Values

| Phase | Metric | Target |
|-------|--------|--------|
| Launch | Adoption | 50% of projects |
| Month 1 | CI first-pass rate | 80% |
| Month 3 | CI first-pass rate | 95% |
| Month 6 | All metrics | Sustained targets |

---

## Appendix A: push-rules.md Template

```markdown
---
version: "1.0"
enabled: true
bypass_flag: "--skip-push-rules"
---

# Git Push Rules

This file defines mandatory checks before pushing code. Enforced by Claude Code hooks.

## Rebase Policy

All branches MUST be rebased on the base branch before pushing. Merge commits are NOT allowed.

- **Base Branch**: main
- **Enforcement**: strict
- **Allow Merge Commits**: false

## Validation Requirements

### Linting

- **Required**: true
- **Command**: `uv run ruff check .`
- **Allow Warnings**: false

### Testing

- **Required**: true
- **Command**: `uv run pytest tests/ -x -q`
- **Minimum Coverage**: 0

## Branch Naming Convention

- **Pattern**: `^(feature|fix|docs|refactor|test)/[a-z0-9-]+$`
- **Enforce**: true
- **Examples**: `feature/add-push-rules`, `fix/hook-timeout`

## Janitor Settings

- **Run After Validation**: true
- **Prune Merged Branches**: true
- **Clean Stale Worktrees**: true
- **Protected Branches**: [main, master, develop]
```

---

## Appendix B: github-janitor Agent Prompt

See task-303 for full agent definition. Key capabilities:

1. **Branch Pruning**: Extends /jpspec:prune-branch
2. **Worktree Cleanup**: Finds and removes orphaned worktrees
3. **PR Status Sync**: Updates backlog tasks based on PR state
4. **Naming Validation**: Reports branches violating conventions
5. **Cleanup Report**: Generates summary of actions taken

---

## Document History

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 2025-12-07 | 1.0 | @pm-planner | Initial PRD creation |
