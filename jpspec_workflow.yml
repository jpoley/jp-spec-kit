# JP Spec Kit Workflow Configuration
# ==============================================================================
#
# This file defines the state machine for /jpspec command workflows in
# Spec-Driven Development (SDD). It is the authoritative source for:
#
#   - Task states: Valid progression states in the development lifecycle
#   - Workflows: /jpspec slash commands with agent assignments
#   - Transitions: State changes triggered by workflow execution
#   - Agent loops: Inner/outer loop classification for execution model
#
# Configuration Version: 1.0
# Compatible with: jp-spec-kit v0.0.102+
#
# References:
#   - docs/reference/agent-loop-classification.md
#   - docs/reference/inner-loop.md
#   - docs/reference/outer-loop.md
#   - .claude/commands/jpspec/*.md
#
# ==============================================================================

version: "1.0"

# ==============================================================================
# TASK STATES
# ==============================================================================
# Valid states a task can occupy during the development lifecycle.
# States progress forward via workflows, with manual transitions to "Done".
#
# State Descriptions:
#   - To Do: Initial state - work has not started
#   - Assessed: SDD workflow suitability evaluated via /jpspec:assess
#   - Specified: Requirements captured via /jpspec:specify
#   - Researched: Technical and business research completed via /jpspec:research
#   - Planned: Architecture and infrastructure planned via /jpspec:plan
#   - In Implementation: Code actively being written via /jpspec:implement
#   - Validated: QA, security, and documentation validated via /jpspec:validate
#   - Deployed: Released to production via /jpspec:operate
#   - Done: Work complete - ready for archive

states:
  - "To Do"
  - "Assessed"
  - "Specified"
  - "Researched"
  - "Planned"
  - "In Implementation"
  - "Validated"
  - "Deployed"
  - "Done"

# ==============================================================================
# WORKFLOW DEFINITIONS
# ==============================================================================
# Each workflow maps to a /jpspec slash command. Agents are assigned based on
# the actual implementations in .claude/commands/jpspec/*.md

workflows:
  # ---------------------------------------------------------------------------
  # /jpspec:assess - SDD Workflow Suitability Assessment
  # ---------------------------------------------------------------------------
  # Evaluates if full SDD workflow, spec-light mode, or skip-SDD is appropriate.
  # Assesses complexity, risk, and architecture impact to recommend workflow path.
  assess:
    command: "/jpspec:assess"
    description: "Evaluate SDD workflow suitability and complexity assessment"
    agents:
      - name: "workflow-assessor"
        identity: "@workflow-assessor"
        description: "SDD Workflow Assessor for complexity and risk evaluation"
        responsibilities:
          - "Complexity analysis (simple, medium, complex)"
          - "Risk assessment and architecture impact evaluation"
          - "SDD workflow path recommendation (Full/Light/Skip)"
          - "Assessment report generation"
    input_states:
      - "To Do"
    output_state: "Assessed"
    optional: false
    creates_backlog_tasks: false

  # ---------------------------------------------------------------------------
  # /jpspec:specify - Requirements and Specification Creation
  # ---------------------------------------------------------------------------
  # Creates comprehensive PRDs with user stories, acceptance criteria, and
  # task breakdowns. Uses SVPG principles (Inspired, Empowered, Transformed).
  specify:
    command: "/jpspec:specify"
    description: "Create or update feature specifications using PM Planner agent"
    agents:
      - name: "product-requirements-manager"
        identity: "@pm-planner"
        description: "Senior Product Strategy Advisor using SVPG principles"
        responsibilities:
          - "Create comprehensive PRDs with 10 sections"
          - "Define user stories and acceptance criteria"
          - "Conduct DVF+V risk assessment (Desirability, Usability, Feasibility, Viability)"
          - "Create implementation tasks in backlog via CLI"
    input_states:
      - "Assessed"
    output_state: "Specified"
    optional: false
    creates_backlog_tasks: true

  # ---------------------------------------------------------------------------
  # /jpspec:research - Technical and Business Validation
  # ---------------------------------------------------------------------------
  # Two-phase workflow: Research (market/competitive/technical analysis) then
  # Business Validation (viability and strategic fit assessment).
  research:
    command: "/jpspec:research"
    description: "Execute research and business validation workflow"
    agents:
      - name: "researcher"
        identity: "@researcher"
        description: "Senior Research Analyst for market, competitive, and technical research"
        responsibilities:
          - "Market analysis (TAM/SAM/SOM, growth trends)"
          - "Competitive landscape assessment"
          - "Technical feasibility evaluation"
          - "Industry trend analysis with sources"
      - name: "business-validator"
        identity: "@business-validator"
        description: "Senior Business Analyst for viability and strategic fit assessment"
        responsibilities:
          - "Financial viability analysis (revenue model, unit economics)"
          - "Operational feasibility assessment"
          - "Strategic alignment evaluation"
          - "Risk analysis and Go/No-Go recommendations"
    input_states:
      - "Specified"
    output_state: "Researched"
    optional: true  # Some features may skip research phase
    creates_backlog_tasks: true

  # ---------------------------------------------------------------------------
  # /jpspec:plan - Architecture and Infrastructure Planning
  # ---------------------------------------------------------------------------
  # Parallel execution of two agents: Software Architect (Hohpe's principles)
  # and Platform Engineer (DevSecOps, DORA metrics, CI/CD).
  plan:
    command: "/jpspec:plan"
    description: "Execute planning workflow using architect and platform engineer agents"
    execution_mode: "parallel"
    agents:
      - name: "software-architect"
        identity: "@software-architect"
        description: "Enterprise Software Architect using Gregor Hohpe's principles"
        responsibilities:
          - "Strategic framing (Penthouse-Engine Room continuum)"
          - "System architecture and component design"
          - "Architecture Decision Records (ADRs)"
          - "Platform Quality Framework (7 C's) assessment"
          - "Enterprise Integration Patterns (EIP) application"
      - name: "platform-engineer"
        identity: "@platform-engineer"
        description: "Principal Platform Engineer for DevSecOps and CI/CD excellence"
        responsibilities:
          - "DORA Elite metrics design (DF, LT, CFR, MTTR)"
          - "CI/CD pipeline architecture"
          - "Infrastructure architecture (Kubernetes, cloud)"
          - "DevSecOps integration (SBOM, SLSA, security gates)"
          - "Observability architecture"
    input_states:
      - "Specified"
      - "Researched"
    output_state: "Planned"
    optional: false
    creates_backlog_tasks: true
    builds_constitution: true  # Contributes to /speckit.constitution

  # ---------------------------------------------------------------------------
  # /jpspec:implement - Code Development with Review
  # ---------------------------------------------------------------------------
  # Implementation agents work from backlog tasks. Code reviewers validate
  # work before completion. Requires existing backlog tasks.
  implement:
    command: "/jpspec:implement"
    description: "Execute implementation using specialized engineer agents with code review"
    agents:
      # Implementation agents (parallel execution)
      - name: "frontend-engineer"
        identity: "@frontend-engineer"
        description: "Senior Frontend Engineer (React, React Native, TypeScript)"
        responsibilities:
          - "Component development with accessibility (WCAG 2.1 AA)"
          - "State management implementation"
          - "Performance optimization"
          - "Frontend testing"
      - name: "backend-engineer"
        identity: "@backend-engineer"
        description: "Senior Backend Engineer (Go, TypeScript/Node.js, Python)"
        responsibilities:
          - "API development (REST, GraphQL, gRPC)"
          - "Business logic implementation"
          - "Database integration"
          - "Backend testing with defensive coding"
      - name: "ai-ml-engineer"
        identity: "@ai-ml-engineer"
        description: "AI/ML Engineer for machine learning implementations"
        responsibilities:
          - "Model development and training"
          - "MLOps infrastructure"
          - "Model deployment and serving"
          - "Performance monitoring"
      # Code review agents (sequential after implementation)
      - name: "frontend-code-reviewer"
        identity: "@frontend-code-reviewer"
        description: "Principal Frontend Code Reviewer"
        responsibilities:
          - "Functionality and performance review"
          - "Accessibility compliance verification"
          - "Code quality assessment"
          - "Security review (XSS prevention)"
      - name: "backend-code-reviewer"
        identity: "@backend-code-reviewer"
        description: "Principal Backend Code Reviewer"
        responsibilities:
          - "Security review (injection prevention)"
          - "Code hygiene enforcement (unused imports, validation)"
          - "Performance and scalability review"
          - "API design review"
    input_states:
      - "Planned"
    output_state: "In Implementation"
    optional: false
    requires_backlog_tasks: true  # Will not proceed without existing tasks
    quality_gate: "specify gate"  # Must pass before implementation

  # ---------------------------------------------------------------------------
  # /jpspec:validate - Quality Assurance and Documentation
  # ---------------------------------------------------------------------------
  # Comprehensive validation: QA testing, security assessment, documentation,
  # and release readiness. Human approval required for production release.
  validate:
    command: "/jpspec:validate"
    description: "Execute validation using QA, security, documentation, and release management agents"
    agents:
      # Phase 1: QA and Security (parallel)
      - name: "quality-guardian"
        identity: "@quality-guardian"
        description: "Quality Guardian for comprehensive QA validation"
        responsibilities:
          - "Functional and integration testing"
          - "API and contract testing"
          - "Performance testing (load, stress, latency)"
          - "Risk analysis and failure mode identification"
      - name: "secure-by-design-engineer"
        identity: "@secure-by-design-engineer"
        description: "Secure-by-Design Engineer for security assessment"
        responsibilities:
          - "Code security review (auth, injection, XSS)"
          - "Dependency vulnerability scanning"
          - "Infrastructure security validation"
          - "Threat modeling and penetration testing"
      # Phase 2: Documentation (after validation)
      - name: "tech-writer"
        identity: "@tech-writer"
        description: "Senior Technical Writer for documentation"
        responsibilities:
          - "API documentation"
          - "User guides and tutorials"
          - "Release notes"
          - "Operational documentation and runbooks"
      # Phase 3: Release Management (final gate)
      - name: "release-manager"
        identity: "@release-manager"
        description: "Senior Release Manager for release coordination"
        responsibilities:
          - "Pre-release validation checklist"
          - "Release planning and risk assessment"
          - "Human approval coordination"
          - "Deployment strategy planning"
    input_states:
      - "In Implementation"
    output_state: "Validated"
    optional: false
    requires_human_approval: true  # Critical decisions require human sign-off

  # ---------------------------------------------------------------------------
  # /jpspec:operate - Production Deployment and Operations
  # ---------------------------------------------------------------------------
  # Establishes operational infrastructure: CI/CD, Kubernetes, observability,
  # and incident management. Follows SRE best practices.
  operate:
    command: "/jpspec:operate"
    description: "Execute operations workflow using SRE agent"
    agents:
      - name: "sre-agent"
        identity: "@sre-agent"
        description: "Principal Site Reliability Engineer"
        responsibilities:
          - "CI/CD pipeline implementation (GitHub Actions)"
          - "Kubernetes deployment and configuration"
          - "DevSecOps integration (SBOM, SLSA compliance)"
          - "Observability stack setup (metrics, logs, traces)"
          - "SLO/SLI definition and monitoring"
          - "Incident management and runbooks"
    input_states:
      - "Validated"
    output_state: "Deployed"
    optional: false
    creates_backlog_tasks: true

# ==============================================================================
# STATE TRANSITIONS
# ==============================================================================
# Valid state transitions in the workflow state machine.
# Forward transitions via workflows, backward transitions for rework/rollback.
#
# Transition Artifact Definitions:
# Each transition includes:
#   - input_artifacts: Required artifacts that must exist before transition
#   - output_artifacts: Artifacts produced by the workflow
#   - validation: Gate mode (NONE | KEYWORD["..."] | PULL_REQUEST)
#
# Artifact Path Variables:
#   - {feature}: Feature name slug (e.g., "user-authentication")
#   - {NNN}: Zero-padded number (e.g., "001", "002", "003")
#   - {slug}: Title slug derived from feature name
#
# Validation Modes:
#   - NONE: No gate - transition proceeds automatically after artifacts created
#   - KEYWORD["<string>"]: User must type exact keyword to proceed
#   - PULL_REQUEST: Transition blocked until PR containing artifact is merged

transitions:
  # Primary forward path
  - name: "assess"
    from: "To Do"
    to: "Assessed"
    via: "assess"
    description: "SDD workflow suitability assessed"
    input_artifacts: []
    output_artifacts:
      - type: "assessment_report"
        path: "./docs/assess/{feature}-assessment.md"
    validation: "NONE"

  - name: "specify"
    from: "Assessed"
    to: "Specified"
    via: "specify"
    description: "Requirements captured and documented"
    input_artifacts:
      - type: "assessment_report"
        path: "./docs/assess/{feature}-assessment.md"
        required: true
    output_artifacts:
      - type: "prd"
        path: "./docs/prd/{feature}.md"
        required: true
      - type: "backlog_tasks"
        path: "./backlog/tasks/*.md"
        required: true
        multiple: true
    validation: "NONE"

  - name: "research"
    from: "Specified"
    to: "Researched"
    via: "research"
    description: "Technical and business research completed"
    input_artifacts:
      - type: "prd"
        path: "./docs/prd/{feature}.md"
        required: true
    output_artifacts:
      - type: "research_report"
        path: "./docs/research/{feature}-research.md"
      - type: "business_validation"
        path: "./docs/research/{feature}-validation.md"
    validation: "NONE"

  - name: "plan_from_specified"
    from: "Specified"
    to: "Planned"
    via: "plan"
    description: "Architecture planned (skipping optional research)"
    input_artifacts:
      - type: "prd"
        path: "./docs/prd/{feature}.md"
        required: true
    output_artifacts:
      - type: "adr"
        path: "./docs/adr/ADR-{NNN}-{slug}.md"
        required: true
        multiple: true
      - type: "platform_design"
        path: "./docs/platform/{feature}-platform.md"
        required: false
    validation: "NONE"

  - name: "plan_from_researched"
    from: "Researched"
    to: "Planned"
    via: "plan"
    description: "Architecture planned after research"
    input_artifacts:
      - type: "prd"
        path: "./docs/prd/{feature}.md"
        required: true
    output_artifacts:
      - type: "adr"
        path: "./docs/adr/ADR-{NNN}-{slug}.md"
        required: true
        multiple: true
      - type: "platform_design"
        path: "./docs/platform/{feature}-platform.md"
        required: false
    validation: "NONE"

  - name: "implement"
    from: "Planned"
    to: "In Implementation"
    via: "implement"
    description: "Implementation work started"
    input_artifacts:
      - type: "adr"
        path: "./docs/adr/ADR-*.md"
        required: true
    output_artifacts:
      - type: "source_code"
        path: "./src/"
      - type: "tests"
        path: "./tests/"
        required: true
      - type: "ac_coverage"
        path: "./tests/ac-coverage.json"
        required: true
    validation: "NONE"

  - name: "validate"
    from: "In Implementation"
    to: "Validated"
    via: "validate"
    description: "QA, security, and documentation validated"
    input_artifacts:
      - type: "tests"
        required: true
      - type: "ac_coverage"
        required: true
    output_artifacts:
      - type: "qa_report"
        path: "./docs/qa/{feature}-qa-report.md"
      - type: "security_report"
        path: "./docs/security/{feature}-security.md"
    validation: "NONE"

  - name: "operate"
    from: "Validated"
    to: "Deployed"
    via: "operate"
    description: "Deployed to production"
    input_artifacts:
      - type: "qa_report"
      - type: "security_report"
    output_artifacts:
      - type: "deployment_manifest"
        path: "./deploy/"
    validation: "NONE"

  # Terminal transitions to Done
  - name: "complete_from_deployed"
    from: "Deployed"
    to: "Done"
    via: "manual"
    description: "Production deployment confirmed successful"
    input_artifacts: []
    output_artifacts: []
    validation: "NONE"

  - name: "complete_from_validated"
    from: "Validated"
    to: "Done"
    via: "manual"
    description: "Feature validated but deployment deferred"
    input_artifacts: []
    output_artifacts: []
    validation: "NONE"

  - name: "complete_from_implementation"
    from: "In Implementation"
    to: "Done"
    via: "manual"
    description: "Implementation complete, validation deferred"
    input_artifacts: []
    output_artifacts: []
    validation: "NONE"

  # Backward transitions for rework
  - name: "rework_to_planned"
    from: "In Implementation"
    to: "Planned"
    via: "rework"
    description: "Rework needed based on implementation findings"
    input_artifacts: []
    output_artifacts: []
    validation: "NONE"

  - name: "rework_to_implementation"
    from: "Validated"
    to: "In Implementation"
    via: "rework"
    description: "Rework needed based on validation findings"
    input_artifacts: []
    output_artifacts: []
    validation: "NONE"

  - name: "rollback"
    from: "Deployed"
    to: "Validated"
    via: "rollback"
    description: "Rollback from production due to issues"
    input_artifacts: []
    output_artifacts: []
    validation: "NONE"

# ==============================================================================
# AGENT LOOP CLASSIFICATION
# ==============================================================================
# Classifies agents by execution model per docs/reference/agent-loop-classification.md
#
# Inner Loop: Fast, local iteration (edit -> run/tests -> debug -> repeat)
#   - Developer velocity and rapid feedback
#   - Pre-commit execution
#   - Code writing, testing, review
#
# Outer Loop: Post-commit CI/CD pipeline
#   - Governance, safety, production reliability
#   - Planning, validation, operations
#   - Build, package, attest, deploy

agent_loops:
  inner:
    description: "Fast, frequent execution - optimized for developer velocity"
    characteristics:
      - "Immediate feedback (< 2s hot reload)"
      - "Local execution before commit"
      - "Code writing and testing focus"
      - "Pre-commit validation"
    agents:
      # Implementation agents
      - "frontend-engineer"
      - "backend-engineer"
      - "ai-ml-engineer"
      # Code review agents
      - "frontend-code-reviewer"
      - "backend-code-reviewer"

  outer:
    description: "Slower, governance-focused - optimized for safety and reliability"
    characteristics:
      - "Post-commit execution"
      - "CI/CD pipeline integration"
      - "Production deployment focus"
      - "Compliance and security gates"
    agents:
      # Assessment phase
      - "workflow-assessor"
      # Planning phase
      - "product-requirements-manager"
      - "researcher"
      - "business-validator"
      - "software-architect"
      - "platform-engineer"
      # Validation phase
      - "quality-guardian"
      - "secure-by-design-engineer"
      - "tech-writer"
      - "release-manager"
      # Operations phase
      - "sre-agent"

# ==============================================================================
# WORKFLOW SEQUENCE DIAGRAM
# ==============================================================================
# Visual representation of the workflow state machine:
#
#   [To Do]
#      |
#      v (assess)
#   [Assessed]
#      |
#      v (specify)
#   [Specified]
#      |
#      +----> (research) ----> [Researched]
#      |                            |
#      +----------------------------+
#      |
#      v (plan)
#   [Planned]
#      |
#      v (implement)
#   [In Implementation] <-----(rework)----+
#      |                                   |
#      v (validate)                        |
#   [Validated] <---------(rework)---------+
#      |                                   |
#      v (operate)                         |
#   [Deployed] <--------(rollback)---------+
#      |
#      v (manual)
#   [Done]
#
# Note: Tasks can also transition directly to [Done] from [In Implementation]
# or [Validated] states via manual transition.

# ==============================================================================
# METADATA
# ==============================================================================

metadata:
  schema_version: "1.0"
  last_updated: "2025-11-30"

  # Counts for validation
  state_count: 9
  workflow_count: 7
  agent_count: 16
  inner_loop_agent_count: 5
  outer_loop_agent_count: 11
  transition_count: 15

  documentation:
    - "docs/reference/agent-loop-classification.md"
    - "docs/reference/inner-loop.md"
    - "docs/reference/outer-loop.md"
    - ".claude/commands/jpspec/*.md"
