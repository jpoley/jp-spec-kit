#!/bin/bash
# Pre-push hook: Run security scan before pushing to remote
# Install: ./scripts/hooks/install-hooks.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo "Running pre-push security scan..."

# Check if specify is available
if ! command -v specflow &> /dev/null; then
    echo "Warning: 'specflow' command not found - skipping security scan"
    echo "Install with: uv tool install specflow-cli --from git+https://github.com/jpoley/jp-spec-kit.git"
    exit 0
fi

# Check if semgrep is available
if ! command -v semgrep &> /dev/null; then
    echo "Warning: 'semgrep' command not found - skipping security scan"
    echo "Install with: pip install semgrep"
    exit 0
fi

# Run security scan on src/ directory (Python code)
echo "Scanning src/ for security issues..."
if ! specflow security scan src/ --fail-on high 2>/dev/null; then
    echo ""
    echo "Security scan failed! Please fix the issues before pushing."
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi

echo "Security scan passed!"
exit 0
